# é‚®ç®±éªŒè¯ç ç™»å½•ç³»ç»Ÿå¼€å‘æ–‡æ¡£  
**åŸºäº Go + Nunu è„šæ‰‹æ¶å®ç°**

---

## ä¸€ã€å‰æœŸå‡†å¤‡

### 1. å¼€å‘å·¥å…·å®‰è£…

- **GoLand IDEï¼ˆ2024.1.1ï¼‰**  
  ä¸‹è½½åœ°å€ï¼š[https://www.jetbrains.com/zh-cn/go/download/other.html](https://www.jetbrains.com/zh-cn/go/download/other.html)

- **Postmanï¼ˆAPI æµ‹è¯•å·¥å…·ï¼‰**  
  ä¸‹è½½åœ°å€ï¼š[https://www.postman.com/downloads/](https://www.postman.com/downloads/)

---

### 2. é¡¹ç›®åŸºç¡€æ¡†æ¶

æœ¬é¡¹ç›®åŸºäº [**nunu**](https://github.com/go-nunu/nunu) è„šæ‰‹æ¶æ„å»ºã€‚  
> **Nunu** æ˜¯ä¸€ä¸ª Golang åº”ç”¨è„šæ‰‹æ¶ï¼Œæ•´åˆäº† Ginã€GORMã€Wireã€Viperã€Zapã€JWT ç­‰ä¸»æµåº“ï¼Œå¸®åŠ©å¿«é€Ÿæ­å»ºé«˜æ•ˆã€å¯é çš„æœåŠ¡ã€‚

```bash
# å®‰è£… nunu CLI
go install github.com/go-nunu/nunu@latest

# åˆ›å»ºæ–°é¡¹ç›®ï¼ˆæ¨èä½¿ç”¨å›½å†…é•œåƒåŠ é€Ÿï¼‰
nunu new emerge-ai-core -r https://gitee.com/go-nunu/nunu-layout-basic.git
```

---

## äºŒã€åŠŸèƒ½æµç¨‹è¯´æ˜

ç”¨æˆ·é€šè¿‡é‚®ç®±éªŒè¯ç å®Œæˆæ— å¯†ç ç™»å½•ï¼š

1. ç”¨æˆ·æäº¤é‚®ç®±ï¼ˆ`email`ï¼‰è¯·æ±‚å‘é€éªŒè¯ç ï¼›
2. æœåŠ¡ç«¯ç”Ÿæˆ 6 ä½æ•°å­—éªŒè¯ç ï¼Œ**ç¼“å­˜ 5 åˆ†é’Ÿ**ï¼Œå¹¶é€šè¿‡ SMTP å‘é€è‡³ç”¨æˆ·é‚®ç®±ï¼›
3. ç”¨æˆ·è¾“å…¥é‚®ç®±å’Œæ”¶åˆ°çš„éªŒè¯ç è¿›è¡Œç™»å½•ï¼›
4. æœåŠ¡ç«¯æ ¡éªŒéªŒè¯ç æœ‰æ•ˆæ€§ï¼š
   - è‹¥æœ‰æ•ˆ â†’ æŸ¥è¯¢æˆ–åˆ›å»ºç”¨æˆ· â†’ ç”Ÿæˆ JWT Token è¿”å›ï¼›
   - è‹¥æ— æ•ˆ â†’ è¿”å›é”™è¯¯ã€‚

> âœ… éªŒè¯ç ä»…å­˜äºå†…å­˜ç¼“å­˜ï¼ˆ`go-cache`ï¼‰ï¼Œ**ä¸è½åº“**ï¼›ç”¨æˆ·ä¿¡æ¯æŒä¹…åŒ–åˆ°æ•°æ®åº“ã€‚

---

## ä¸‰ã€æ•°æ®åº“è®¾è®¡

### 1. è¡¨ç»“æ„ï¼š`users`

| å­—æ®µå      | ç±»å‹         | è¯´æ˜             |
|------------|--------------|------------------|
| id         | VARCHAR(255) | ä¸»é”®ï¼ŒUUID       |
| email      | VARCHAR(255) | å”¯ä¸€ï¼Œä¸å¯ä¸ºç©º   |
| created_at | TIMESTAMP    | åˆ›å»ºæ—¶é—´         |
| updated_at | TIMESTAMP    | æ›´æ–°æ—¶é—´         |
| deleted_at | TIMESTAMP    | è½¯åˆ é™¤å­—æ®µ       |

#### SQL å»ºè¡¨è¯­å¥ï¼š
```sql
CREATE TABLE users (
    id         VARCHAR(255) NOT NULL PRIMARY KEY,
    email      VARCHAR(255) NOT NULL UNIQUE,
    created_at TIMESTAMP    NOT NULL,
    updated_at TIMESTAMP    NOT NULL,
    deleted_at TIMESTAMP    NULL,
    INDEX idx_deleted_at (deleted_at)
);
```

> ğŸ’¡ å»ºè®®åœ¨ GoLand å³ä¾§ Database é¢æ¿ç›´æ¥è¿æ¥ MySQL è¿›è¡Œå»ºè¡¨ä¸è°ƒè¯•ã€‚

---

### 2. æ•°æ®åº“é…ç½®ï¼ˆ`config/local.yml`ï¼‰

```yaml
database:
  driver: mysql
  host: 127.0.0.1
  port: 3306
  name: your_db_name          # æ›¿æ¢ä¸ºä½ çš„æ•°æ®åº“å
  user: root
  password: your_password
  charset: utf8mb4
  parseTime: true
  loc: Asia/Shanghai
```

---

## å››ã€æ ¸å¿ƒä»£ç å®ç°

### 1. æ•°æ®æ¨¡å‹ï¼ˆ`internal/model/user.go`ï¼‰

```go
package model

import (
	"time"
	"gorm.io/gorm"
)

type User struct {
	Id        string `gorm:"primarykey"`
	Email     string `gorm:"not null;uniqueIndex"`
	CreatedAt time.Time
	UpdatedAt time.Time
	DeletedAt gorm.DeletedAt `gorm:"index"`
}

func (u *User) TableName() string {
	return "users"
}
```

---

### 2. API è¯·æ±‚/å“åº”ç»“æ„ï¼ˆ`api/v1/user.go`ï¼‰

```go
package v1

type LoginResponseData struct {
	AccessToken string `json:"accessToken"`
}

type SendVerificationCodeRequest struct {
	Email string `json:"email" binding:"required,email"`
}

type LoginByVerificationCodeRequest struct {
	Email string `json:"email" binding:"required,email"`
	Code  string `json:"code" binding:"required,len=6"`
}
```

---

### 3. ç”¨æˆ·ä»“åº“å±‚ï¼ˆ`internal/repository/user.go`ï¼‰

```go
package repository

import (
	"context"
	"errors"
	"fmt"
	"time"

	"emerge-ai-core/common/utils"
	"emerge-ai-core/internal/model"
	"gorm.io/gorm"
)

type UserRepository interface {
	GetByEmail(ctx context.Context, email string) (*model.User, error)
	CreateUserByEmail(ctx context.Context, email string) (*model.User, error)
}

type userRepository struct {
	*Repository
}

func (r *userRepository) GetByEmail(ctx context.Context, email string) (*model.User, error) {
	var user model.User
	err := r.DB(ctx).Where("email = ?", email).First(&user).Error
	return &user, err
}

func (r *userRepository) CreateUserByEmail(ctx context.Context, email string) (*model.User, error) {
	now := time.Now()
	user := &model.User{
		Id:        utils.GenerateUUID(),
		Email:     email,
		CreatedAt: now,
		UpdatedAt: now,
	}
	if err := r.DB(ctx).Create(user).Error; err != nil {
		return nil, fmt.Errorf("failed to create user: %w", err)
	}
	return user, nil
}
```

---

### 4. é‚®ä»¶æœåŠ¡ï¼ˆ`internal/service/email.go`ï¼‰

> ä½¿ç”¨ **QQ é‚®ç®± SMTP** å‘é€éªŒè¯ç ï¼ˆéœ€å¼€å¯æœåŠ¡å¹¶è·å–æˆæƒç ï¼‰

```go
package service

import (
	"context"
	"fmt"
	"math/rand"
	"net/smtp"
	"time"

	"github.com/jordan-wright/email"
	"github.com/patrickmn/go-cache"
)

var verificationCodeCache = cache.New(5*time.Minute, 10*time.Minute)

type EmailService interface {
	SendVerificationCode(ctx context.Context, to string) error
	VerifyVerificationCode(email, code string) bool
}

type emailService struct{}

func NewEmailService() EmailService {
	return &emailService{}
}

func (e *emailService) SendVerificationCode(ctx context.Context, to string) error {
	code := generateVerificationCode()
	if err := e.sendVerificationCode(to, code); err != nil {
		return err
	}
	verificationCodeCache.Set(to, code, cache.DefaultExpiration)
	return nil
}

func (e *emailService) sendVerificationCode(to, code string) error {
	em := email.NewEmail()
	em.From = "YourName <your_email@qq.com>" // æ›¿æ¢ä¸ºä½ çš„ QQ é‚®ç®±
	em.To = []string{to}
	em.Subject = "ã€éªŒè¯ç ã€‘æ‚¨çš„ç™»å½•éªŒè¯ç "
	em.HTML = []byte(fmt.Sprintf(`
		<h2>éªŒè¯ç </h2>
		<p>æ‚¨çš„éªŒè¯ç æ˜¯ï¼š<strong>%s</strong>ï¼ˆ5åˆ†é’Ÿå†…æœ‰æ•ˆï¼‰</p>
	`, code))

	// ä½¿ç”¨ QQ é‚®ç®± SMTPï¼ˆ587 + STARTTLSï¼‰
	auth := smtp.PlainAuth("", "your_email@qq.com", "ä½ çš„æˆæƒç ", "smtp.qq.com")
	return em.Send("smtp.qq.com:587", auth)
}

func generateVerificationCode() string {
	rand.Seed(time.Now().UnixNano())
	return fmt.Sprintf("%06d", rand.Intn(1000000))
}

func (e *emailService) VerifyVerificationCode(email, code string) bool {
	// è°ƒè¯•ç”¨ï¼š123456 æ°¸è¿œé€šè¿‡
	if code == "123456" {
		return true
	}
	cached, found := verificationCodeCache.Get(email)
	return found && cached == code
}
```

> ğŸ”‘ **è·å– QQ é‚®ç®±æˆæƒç æ­¥éª¤**ï¼š
> 1. ç™»å½• QQ é‚®ç®± â†’ è®¾ç½® â†’ è´¦å·ï¼›
> 2. æ»šåŠ¨åˆ°åº•éƒ¨ â†’ å¼€å¯ **SMTP æœåŠ¡**ï¼›
> 3. æŒ‰æç¤ºç»‘å®šæ‰‹æœº â†’ è·å– **16 ä½æˆæƒç **ï¼ˆéç™»å½•å¯†ç ï¼ï¼‰ã€‚

---

### 5. ç”¨æˆ·æœåŠ¡ï¼ˆ`internal/service/user.go`ï¼‰

```go
package service

import (
	"context"
	"errors"
	"time"

	"emerge-ai-core/internal/model"
	"emerge-ai-core/internal/repository"
	"gorm.io/gorm"
)

type UserService interface {
	GenerateTokenByUserEmail(ctx context.Context, email string) (string, error)
}

type userService struct {
	userRepo repository.UserRepository
	*Service
}

func (s *userService) GenerateTokenByUserEmail(ctx context.Context, email string) (string, error) {
	user, err := s.userRepo.GetByEmail(ctx, email)
	if err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			user, err = s.userRepo.CreateUserByEmail(ctx, email)
			if err != nil {
				return "", err
			}
		} else {
			return "", err
		}
	}

	token, err := s.jwt.GenToken(user.Id, time.Now().Add(24*time.Hour))
	if err != nil {
		return "", err
	}
	return token, nil
}
```

---

### 6. HTTP å¤„ç†å™¨ï¼ˆ`internal/handler/user.go`ï¼‰

```go
package handler

import (
	"net/http"

	"emerge-ai-core/api/v1"
	"emerge-ai-core/internal/service"
	"github.com/gin-gonic/gin"
)

type UserHandler struct {
	*Handler
	userService  service.UserService
	emailService service.EmailService
}

func (h *UserHandler) SendVerificationCode(ctx *gin.Context) {
	var req v1.SendVerificationCodeRequest
	if err := ctx.ShouldBindJSON(&req); err != nil {
		v1.HandleError(ctx, http.StatusBadRequest, v1.ErrBadRequest, err.Error())
		return
	}

	if err := h.emailService.SendVerificationCode(ctx, req.Email); err != nil {
		v1.HandleError(ctx, http.StatusInternalServerError, v1.ErrInternalServerError, err.Error())
		return
	}
	v1.HandleSuccess(ctx, nil)
}

func (h *UserHandler) LoginByVerificationCode(ctx *gin.Context) {
	var req v1.LoginByVerificationCodeRequest
	if err := ctx.ShouldBindJSON(&req); err != nil {
		v1.HandleError(ctx, http.StatusBadRequest, v1.ErrBadRequest, err.Error())
		return
	}

	if !h.emailService.VerifyVerificationCode(req.Email, req.Code) {
		v1.HandleError(ctx, http.StatusBadRequest, "éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ", nil)
		return
	}

	token, err := h.userService.GenerateTokenByUserEmail(ctx, req.Email)
	if err != nil {
		v1.HandleError(ctx, http.StatusInternalServerError, v1.ErrInternalServerError, err.Error())
		return
	}

	v1.HandleSuccess(ctx, v1.LoginResponseData{AccessToken: token})
}
```

---

### 7. è·¯ç”±æ³¨å†Œï¼ˆ`internal/server/http.go`ï¼‰

```go
v1 := s.Group("/v1")
{
	public := v1.Group("/public")
	{
		public.POST("/send-verification-code", userHandler.SendVerificationCode)
		public.POST("/login", userHandler.LoginByVerificationCode)
	}
}
```

> âœ… æœ€ç»ˆ API è·¯å¾„ï¼š
> - `POST /v1/public/send-verification-code`
> - `POST /v1/public/login`

---

## äº”ã€Postman æµ‹è¯•ç¤ºä¾‹

### 1. å‘é€éªŒè¯ç 
```http
POST http://localhost:3000/v1/public/send-verification-code
Content-Type: application/json

{
  "email": "1417167991@qq.com"
}
```
âœ… æˆåŠŸè¿”å›ï¼š`{ "success": true }`

### 2. éªŒè¯ç ç™»å½•
```http
POST http://localhost:3000/v1/public/login
Content-Type: application/json

{
  "email": "1417167991@qq.com",
  "code": "123456"  // æˆ–çœŸå®æ”¶åˆ°çš„éªŒè¯ç 
}
```
âœ… æˆåŠŸè¿”å›ï¼š
```json
{
  "success": true,
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.xxxxx"
  }
}
```

> ğŸ’¡ æ”¯æŒ Googleã€QQã€163 ç­‰ä»»æ„é‚®ç®±æ¥æ”¶éªŒè¯ç ï¼Œåªéœ€ç¡®ä¿ SMTP é…ç½®æ­£ç¡®ã€‚

---

## å…­ã€å¸¸è§é—®é¢˜æ’æŸ¥

### âŒ é—®é¢˜ï¼šå‘é€é‚®ä»¶å¤±è´¥ `EOF`
- **åŸå› **ï¼šSMTP ç«¯å£/åŠ å¯†æ–¹å¼ä¸åŒ¹é…ï¼ˆå¦‚ 163 é‚®ç®±å¿…é¡»ç”¨ 465 + SSLï¼‰ã€‚
- **è§£å†³**ï¼šç»Ÿä¸€ä½¿ç”¨ **QQ é‚®ç®± + 587 + STARTTLS** æˆ– **163 é‚®ç®± + 465 + SSL**ï¼Œå¹¶ä½¿ç”¨**æˆæƒç **ã€‚

### âŒ é—®é¢˜ï¼šéªŒè¯ç æ— æ•ˆ
- æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼ˆ5 åˆ†é’Ÿï¼‰ï¼›
- ç¡®è®¤ `go-cache` å®ä¾‹æ˜¯å…¨å±€å•ä¾‹ï¼›
- è°ƒè¯•æ—¶å¯ç”¨ `123456` ç»•è¿‡éªŒè¯ã€‚

### âœ… å®‰å…¨å»ºè®®
- ç”Ÿäº§ç¯å¢ƒç§»é™¤ `code == "123456"` çš„è°ƒè¯•é€»è¾‘ï¼›
- é™åˆ¶éªŒè¯ç å‘é€é¢‘ç‡ï¼ˆå¦‚ 60 ç§’/æ¬¡ï¼‰ï¼›
- JWT å¯†é’¥ä¸è¦ç¡¬ç¼–ç ã€‚

---

## ä¸ƒã€é¡¹ç›®ç»“æ„æ¦‚è§ˆ

```
emerge-ai-core/
â”œâ”€â”€ api/v1/               # API å®šä¹‰
â”œâ”€â”€ config/               # é…ç½®æ–‡ä»¶ï¼ˆlocal.ymlï¼‰
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ model/            # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ repository/       # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ service/          # ä¸šåŠ¡é€»è¾‘ï¼ˆå«é‚®ä»¶ã€ç”¨æˆ·ï¼‰
â”‚   â””â”€â”€ handler/          # HTTP å¤„ç†å™¨
â”œâ”€â”€ pkg/                  # å·¥å…·åŒ…ï¼ˆjwt, log, utilsï¼‰
â””â”€â”€ go.mod
```

---

> ğŸ‰ è‡³æ­¤ï¼Œä½ å·²æˆåŠŸå®ç°ä¸€ä¸ªå®Œæ•´çš„ **é‚®ç®±éªŒè¯ç ç™»å½•ç³»ç»Ÿ**ï¼  
> å¯æ‰©å±•ï¼šå¢åŠ å›¾å½¢éªŒè¯ç ã€æ‰‹æœºå·ç™»å½•ã€ç¬¬ä¸‰æ–¹ OAuth ç­‰ã€‚